{% extends "base.html" %}
{% block content %}
<section class="dashboard-header">
  <div>
    <h1 class="dashboard-title">Savings Goals</h1>
    <p class="dashboard-subtitle">
      Track where youâ€™re heading and how close you are.
    </p>
  </div>
</section>

<section style="display: grid; grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr); gap: 1.1rem">
  <!-- Goals list -->
  <div class="card">
    <div class="card-inner">
      <div class="card-header">
        <span class="card-title">Active Goals</span>
        <span class="card-tag">
          {{ goals|length }} total
        </span>
      </div>

      <div class="goals-list" id="goals-list">
        {% if goals %}
          {% for g in goals %}
            {% set pct = (g.Saving / g.amount * 100) if g.amount else 0 %}
            <div class="goal-item"
                 data-goal-id="{{ g.Gid }}"   
                 style="cursor: pointer">
              <div class="goal-top">
                <span class="goal-name">{{ g.title }}</span>
                <span class="goal-progress">
                  â‚¹ {{ '%.0f'|format(g.Saving) }} / {{ '%.0f'|format(g.amount) }}
                </span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: {{ pct|round(0) }}%"></div>
              </div>
              <p class="dashboard-subtitle" style="margin-top: 0.25rem">
                Created on {{ g.dateAdded.strftime('%d %b %Y') }}
              </p>
            </div>
          {% endfor %}
        {% else %}
          <p class="dashboard-subtitle" id="no-goal-text">
            No goals yet. Add your first goal on the right.
          </p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Create goal form -->
  <div class="card">
    <div class="card-inner">
      <div class="card-header">
        <span class="card-title">Create Goal</span>
        <!-- <span class="card-tag">AJAX Â· No reload</span> -->
      </div>

      <div id="goal-form">
        <div class="form-grid">
          <div class="form-field">
            <label for="title">Goal name</label>
            <input
              type="text"
              id="title"
              name="title"
              placeholder="e.g. Emergency fund"
              required
            />
          </div>

          <div class="form-field">
            <label for="amount">Target amount (â‚¹)</label>
            <input
              type="number"
              id="amount"
              name="amount"
              min="0"
              step="0.01"
              placeholder="0.00"
              required
            />
          </div>

          <div class="form-field">
            <label for="saving">Current saved (â‚¹)</label>
            <input
              type="number"
              id="saving"
              name="saving"
              min="0"
              step="0.01"
              placeholder="0.00"
            />
          </div>

          <div class="form-field">
            <label for="date">Target date</label>
            <input type="date" id="date" name="date" />
          </div>
        </div>

        <div style="margin-top: 0.7rem; display: flex; gap: 0.5rem; justify-content: flex-end">
          <button type="reset" class="btn btn-secondary">Reset</button>
          <button type="button" class="btn" id="addGoal">Save Goal</button>
        </div>
      </div>
    </div>
  </div>
</section>


<script>
  const resetData = () => {
    document.getElementById("title").value = "";
    document.getElementById("amount").value = "";
    document.getElementById("saving").value = "";
    document.getElementById("date").value = "";
  };

  // ðŸ”¹ Fetch all goals (JSON) and re-render the list
  const loadData = async () => {
    const list = document.getElementById("goals-list");
    list.innerHTML = "";

    try {
      // NOTE: this assumes POST /goals returns JSON list of goals
      const res = await fetch("/goals", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      const data = await res.json();

      // update "X total"
      document.getElementsByClassName("card-tag")[0].innerHTML = `${data.length} total`;

      if (!data.length) {
        list.innerHTML =
          '<p class="dashboard-subtitle" id="no-goal-text">No goals yet. Add your first goal on the right.</p>';
        return;
      }

      data.forEach((goal) => {
        const pct =
          goal.target === 0 ? 0 : Math.round((goal.saved / goal.target) * 100);

        const div = document.createElement("div");
        div.className = "goal-item";
        div.style.cursor = "pointer";
        div.setAttribute("data-goal-id", goal.id); // ðŸ”´ for editing

        div.innerHTML = `
          <div class="goal-top">
            <span class="goal-name">${goal.title}</span>
            <span class="goal-progress">
              â‚¹ ${goal.saved.toFixed(0)} / ${goal.target.toFixed(0)}
            </span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${pct}%"></div>
          </div>
          <p class="dashboard-subtitle" style="margin-top: 0.25rem">
            Created on ${goal.date}
          </p>
        `;

        list.appendChild(div);
      });
    } catch (err) {
      console.error(err);
      alert("Network error while fetching goals");
    }
  };

  // ðŸ”¹ Ask user for new saved value & send to backend
  const editGoalSaved = async (goalId, currentSaved, target) => {
    const input = prompt(
      `Update saved amount for this goal (target: â‚¹${target.toFixed(0)}):`,
      currentSaved.toFixed(0)
    );

    if (input === null) return; // user cancelled

    const newSaved = parseFloat(input);
    if (isNaN(newSaved) || newSaved < 0) {
      alert("Please enter a valid positive number");
      return;
    }
    if (newSaved > target) {
      const ok = confirm(
        `You entered â‚¹${newSaved.toFixed(
          0
        )}, which is more than target â‚¹${target.toFixed(
          0
        )}. Continue anyway?`
      );
      if (!ok) return;
    }

    try {
      // ðŸ”´ You must implement this route in Flask (see below)
      const res = await fetch("/updategoalsaving", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: goalId, saved: newSaved }),
      });

      const data = await res.json();
      if (!data.ok) {
        alert(data.error || "Failed to update goal");
        return;
      }

      await loadData(); // refresh list
    } catch (err) {
      console.error(err);
      alert("Network error while updating goal");
    }
  };

  document.addEventListener("DOMContentLoaded", () => {




    















    // default date = today
    document.getElementById("date").value =
      new Date().toISOString().split("T")[0];

    // initial load
    loadData();

    // Add goal button
    document
      .getElementById("addGoal")
      .addEventListener("click", async () => {
        const title = document.getElementById("title").value;
        const amount = document.getElementById("amount").value;
        const saving = document.getElementById("saving").value || 0;
        const date = document.getElementById("date").value;

        const url =
          "/add_goals?title=" +
          encodeURIComponent(title) +
          "&amount=" +
          encodeURIComponent(amount) +
          "&saving=" +
          encodeURIComponent(saving) +
          "&dateAdded=" +
          encodeURIComponent(date);

        try {
          const res = await fetch(url, {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          });

          if (res.ok) {
            resetData();
            await loadData();
          } else {
            alert("Failed to save goal");
          }
        } catch (err) {
          console.error(err);
          alert("Network error while saving goal");
        }
      });

    // ðŸ”¹ Make every goal tappable (event delegation)
    document
      .getElementById("goals-list")
      .addEventListener("click", (e) => {
        const item = e.target.closest(".goal-item");
        if (!item) return;

        const goalId = parseInt(item.getAttribute("data-goal-id"), 10);
        if (!goalId) return;

        // Read current text to get saved & target
        const progressText = item.querySelector(".goal-progress").textContent;
        // Format: "â‚¹ 1000 / 5000"
        const match = progressText.match(/â‚¹\s*([\d.]+)\s*\/\s*([\d.]+)/);
        if (!match) {
          console.warn("Could not parse goal progress text:", progressText);
          return;
        }
        const currentSaved = parseFloat(match[1]);
        const target = parseFloat(match[2]);

        editGoalSaved(goalId, currentSaved, target);
      });
  });
</script>

{% endblock %}